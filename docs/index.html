<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Au Jour Le Jour</title>
    <link rel="stylesheet" href="styles.css?v=20260224-8" />
    <link rel="manifest" href="manifest.json?v=20260224-8" />
    <meta name="theme-color" content="#0f172a" />
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        if (!params.has("reset") && !params.has("nosw")) return;
        const clear = async () => {
          try {
            if ("serviceWorker" in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              await Promise.all(regs.map((reg) => reg.unregister()));
            }
            if ("caches" in window) {
              const keys = await caches.keys();
              await Promise.all(keys.map((key) => caches.delete(key)));
            }
            try {
              const dbs = await indexedDB.databases?.();
              if (Array.isArray(dbs)) {
                await Promise.all(
                  dbs
                    .map((entry) => entry && entry.name)
                    .filter((name) => typeof name === "string" && name.startsWith("ajl_pwa"))
                    .map(
                      (name) =>
                        new Promise((resolve) => {
                          const req = indexedDB.deleteDatabase(name);
                          req.onsuccess = () => resolve();
                          req.onerror = () => resolve();
                          req.onblocked = () => resolve();
                        })
                    )
                );
              } else {
                const req = indexedDB.deleteDatabase("ajl_pwa");
                req.onsuccess = () => null;
                req.onerror = () => null;
                req.onblocked = () => null;
              }
            } catch (err) {
              const req = indexedDB.deleteDatabase("ajl_pwa");
              req.onsuccess = () => null;
              req.onerror = () => null;
              req.onblocked = () => null;
            }
            try {
              window.localStorage.removeItem("ajl_pwa_db_name");
            } catch (err) {
              // ignore
            }
          } finally {
            const cleanUrl = window.location.origin + window.location.pathname;
            window.location.replace(cleanUrl);
          }
        };
        clear();
      })();
    </script>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="brand-mark">AJL</div>
        <div>
          <div class="brand-title">Au Jour Le Jour</div>
          <div class="brand-sub">Essentials ledger</div>
        </div>
      </div>

      <div class="month-nav">
        <button id="prev-month" class="icon-btn" aria-label="Previous month">&#x2039;</button>
        <input id="month-picker" class="month-input" type="month" />
        <button id="next-month" class="icon-btn" aria-label="Next month">&#x203A;</button>
      </div>

      <div class="top-actions">
        <label class="toggle">
          <input id="essentials-toggle" type="checkbox" checked />
          <span>Essentials only</span>
        </label>
          <button id="reset-local" class="ghost-btn danger">Reset local data</button>
        <button id="nav-dashboard" class="tab-btn active">This Month</button>
        <button id="nav-templates" class="tab-btn">Templates</button>
        <button id="open-backup" class="primary-btn">Backup/Export</button>
      </div>
    </header>

    <main class="container">
      <section id="dashboard-view" class="view">
        <div id="zero-state" class="zero-state hidden">
          <div class="zero-card">
            <div class="zero-title">No bills yet.</div>
            <div class="zero-sub">Add essentials to generate your monthly list.</div>
            <button id="zero-templates-btn" class="primary-btn">Go to Templates</button>
            <button id="zero-intake-btn" class="ghost-btn">Add bills by describing them</button>
          </div>
        </div>

        <div class="card hero">
          <div class="hero-left">
            <div class="hero-primary">
              <div class="hero-metric">
                <div class="hero-label">Required</div>
                <div id="required-amount" class="hero-value">$0.00</div>
              </div>
              <div class="hero-metric">
                <div class="hero-label">Paid</div>
                <div id="paid-amount" class="hero-value">$0.00</div>
              </div>
              <div class="hero-metric">
                <div class="hero-label">Remaining</div>
                <div id="remaining-amount" class="hero-value">$0.00</div>
              </div>
            </div>
            <div class="hero-subline">
              <span>Future reserved: <span id="future-reserved">$0.00</span></span>
              <button id="piggy-cta" class="link-btn">Add piggy bank</button>
            </div>
          </div>
          <div class="hero-right">
            <div class="hero-side">
              <div class="hero-mini">
                <div class="hero-label">Need / Day</div>
                <div id="need-day" class="hero-mini-value">$0.00</div>
                <div id="need-day-plan" class="hero-caption">Planning avg: $0.00/day</div>
              </div>
              <div class="hero-mini">
                <div class="hero-label">Need / Week</div>
                <div id="need-week" class="hero-mini-value">$0.00</div>
                <div id="need-week-plan" class="hero-caption">Planning avg: $0.00/week</div>
              </div>
            </div>
            <div class="cash-block">
              <label for="cash-start">Cash on hand</label>
              <div class="cash-row">
                <div class="cash-input">
                  <span class="cash-prefix">$</span>
                  <input id="cash-start" type="number" min="0" step="0.01" placeholder="0.00" />
                </div>
                <button id="cash-save" class="btn-small btn-primary" disabled>Save</button>
              </div>
              <div class="cash-caption">Updates as you log payments.</div>
              <div id="cash-empty" class="cash-empty">Set cash to track runway.</div>
              <div class="cash-remaining"><span id="cash-remaining">$0.00</span></div>
              <div id="cash-save-status" class="meta"></div>
            </div>
            <div id="hero-status" class="status-box">
              <div id="status-main" class="status-main">Remaining this month: $0</div>
              <div id="status-sub" class="status-sub">You're not free yet.</div>
            </div>
          </div>
        </div>

        <div id="urgency-row" class="row">
          <div class="col col-8">
            <div id="overdue-card" class="card compact-card">
              <div class="card-title">Overdue</div>
              <div id="overdue-list" class="list"></div>
            </div>
            <div id="due-soon-card" class="card compact-card">
              <div class="card-title">Due soon</div>
              <div id="due-soon-list" class="list"></div>
            </div>
          </div>
          <div class="col col-4">
            <div class="card compact-card">
              <div class="card-title">Recent activity</div>
              <div id="activity-list" class="list"></div>
            </div>
            <div id="assistant-card" class="card compact-card assistant-card">
              <div class="card-title">Mamdou</div>
              <div id="nudges-list" class="list"></div>
              <button id="assistant-toggle" class="assistant-pill">Hide Mamdou</button>
              <div id="assistant-panel" class="assistant-panel">
                <div class="assistant-box">
                  <div class="assistant-title">Mamdou</div>
                  <div class="assistant-sub">Ask, add bills, or run commands in one box.</div>
                  <div class="assistant-personal">
                    <div id="assistant-greeting" class="assistant-greeting">Hi there.</div>
                    <label class="assistant-name-label" for="assistant-name-input">Call me</label>
                    <div class="assistant-name-row">
                      <input id="assistant-name-input" class="assistant-name-input" type="text" placeholder="Name (optional)" />
                      <button id="assistant-name-save" class="btn-link">Save</button>
                    </div>
                    <div class="assistant-name-hint">Stored locally on this device.</div>
                  </div>
                  <div class="assistant-capabilities">
                    <div class="cap-title">What Mamdou Can Do</div>
                    <div class="cap-sub">All actions require confirmation.</div>
                    <div class="cap-tags">
                      <span class="cap-chip">Pay / undo payments</span>
                      <span class="cap-chip">Update bills</span>
                      <span class="cap-chip">Create / update templates</span>
                      <span class="cap-chip">Apply templates</span>
                      <span class="cap-chip">Piggy banks</span>
                      <span class="cap-chip">Cash on hand</span>
                      <span class="cap-chip">Exports</span>
                      <span class="cap-chip">Switch month</span>
                      <span class="cap-chip">Toggle essentials</span>
                    </div>
                  </div>
                  <textarea id="llm-agent-input" class="assistant-input" rows="3" placeholder="Try: “add Rent $1200 on the 1st, Electric $140 on the 10th” or “mark rent paid”"></textarea>
                  <div class="assistant-actions">
                    <button id="llm-agent-send" class="btn-small btn-primary">Send</button>
                  </div>
                  <div id="llm-agent-output" class="assistant-status meta"></div>
                  <div id="llm-agent-actions" class="assistant-actions-row hidden">
                    <button id="llm-agent-confirm" class="btn-pill primary">Confirm</button>
                    <button id="llm-agent-cancel" class="btn-pill">Cancel</button>
                  </div>
                  <div id="llm-agent-history" class="assistant-thread"></div>
                  <div class="assistant-log">
                    <div class="assistant-log-heading">Command log</div>
                    <div id="llm-command-log" class="assistant-log-list"></div>
                  </div>
                  <button id="llm-chat-clear" class="assistant-clear">Clear chat</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="piggy-card" class="card">
          <div class="card-title-row">
            <div class="card-title">Piggy Banks</div>
            <button id="open-piggy-manage" class="ghost-btn">Manage</button>
          </div>
          <div id="piggy-list" class="piggy-list"></div>
        </div>

        <div id="items-card" class="card all-items">
          <div class="card-title">All items</div>
          <div class="filters">
            <input id="search-input" class="search-input" type="search" placeholder="Search bills..." />
            <div class="filter-group">
              <span>Status</span>
              <label class="chip"><input type="checkbox" data-status="pending" checked />Pending</label>
              <label class="chip"><input type="checkbox" data-status="partial" checked />Partial</label>
              <label class="chip"><input type="checkbox" data-status="paid" checked />Paid</label>
              <label class="chip"><input type="checkbox" data-status="skipped" checked />Skipped</label>
            </div>
            <div class="filter-group">
              <span>Category</span>
              <select id="category-filter" class="select">
                <option value="all">All</option>
              </select>
            </div>
            <div class="filter-group">
              <span>Sort</span>
              <select id="sort-filter" class="select">
                <option value="due_date">Due date</option>
                <option value="amount">Amount</option>
                <option value="name">Name</option>
              </select>
            </div>
          </div>

          <div id="items-list" class="items-list"></div>
        </div>

        <div id="review-card" class="card">
          <div class="card-title">Month review</div>
          <div id="review-summary" class="review-grid"></div>
          <div id="review-list" class="list"></div>
        </div>
      </section>

      <section id="templates-view" class="view hidden">
        <div class="page-title">Recurring bills</div>
        <div class="page-sub">These generate your monthly checklist.</div>
        <button id="open-intake" class="ghost-btn">Add bills (Mamdou)</button>

        <form id="template-form" class="template-form">
          <input id="template-name" type="text" placeholder="Name" required />
          <input id="template-category" type="text" placeholder="Category" />
          <input id="template-amount" type="number" min="0" step="0.01" placeholder="Amount" required />
          <input id="template-due-day" type="number" min="1" max="31" placeholder="Due day" required />
          <label class="toggle small">
            <input id="template-essential" type="checkbox" checked />
            <span>Essential</span>
          </label>
          <label class="toggle small">
            <input id="template-autopay" type="checkbox" />
            <span>Autopay</span>
          </label>
          <label class="toggle small">
            <input id="template-active" type="checkbox" checked />
            <span>Active</span>
          </label>
          <input id="template-note" type="text" placeholder="Default note" />
          <input id="template-match-key" type="text" placeholder="Match key" />
          <input id="template-match-tolerance" type="number" min="0" step="0.01" placeholder="Match tolerance" />
          <button class="primary-btn" type="submit">Add bill</button>
        </form>
        <div id="template-error" class="form-error hidden"></div>

        <div class="template-actions">
          <label class="toggle small">
            <input id="select-all-templates" type="checkbox" />
            <span>Select all</span>
          </label>
          <button id="archive-selected" class="ghost-btn" disabled>Archive selected</button>
          <button id="delete-selected" class="ghost-btn" disabled>Delete selected</button>
          <button id="apply-templates" class="ghost-btn">Apply template updates to this month</button>
        </div>

        <div id="templates-list" class="templates-list"></div>

        <div id="funds-section" class="section-title">Piggy banks</div>
        <div class="page-sub">Sinking funds for yearly or quarterly obligations.</div>

        <form id="fund-form" class="template-form">
          <input id="fund-name" type="text" placeholder="Name" required />
          <input id="fund-category" type="text" placeholder="Category" />
          <input id="fund-target" type="number" min="0" step="0.01" placeholder="Target amount" required />
          <input id="fund-due-date" type="date" required />
          <select id="fund-cadence" class="select">
            <option value="yearly">Yearly</option>
            <option value="quarterly">Quarterly</option>
            <option value="custom_months">Custom months</option>
          </select>
          <input id="fund-months" type="number" min="1" step="1" placeholder="Months per cycle" />
          <label class="toggle small">
            <input id="fund-essential" type="checkbox" checked />
            <span>Essential</span>
          </label>
          <label class="toggle small">
            <input id="fund-auto" type="checkbox" checked />
            <span>Auto contribute</span>
          </label>
          <label class="toggle small">
            <input id="fund-active" type="checkbox" checked />
            <span>Active</span>
          </label>
          <button class="primary-btn" type="submit">Add fund</button>
        </form>
        <div id="fund-error" class="form-error hidden"></div>
        <div id="funds-list" class="templates-list"></div>
      </section>
    </main>

    <div id="backup-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title">Backup & Export</div>
            <div class="modal-sub">Keeps your data portable across computers.</div>
          </div>
          <button id="close-backup" class="icon-btn" aria-label="Close">&times;</button>
        </div>
        <div class="modal-actions">
          <button id="export-month" class="primary-btn">Export month CSV</button>
          <button id="export-backup" class="ghost-btn">Export full backup (JSON)</button>
          <label class="ghost-btn file-input">
            Import backup (JSON)
            <input id="import-backup" type="file" accept="application/json" />
          </label>
        </div>
      </div>
    </div>

    <!-- Intake modal removed: use the unified assistant box instead. -->

    <script>
      window.AJL_WEB_MODE = true;
      window.AJL_LLM_BASE_URL = "";
    </script>
    <script src="vendor/dexie.min.js?v=20260224-8"></script>
    <script src="pwa-adapter.js?v=20260224-8"></script>
    <script src="app.js?v=20260224-8"></script>
    <!-- Service worker disabled for web build to avoid stale cache loops. -->
  </body>
</html>
